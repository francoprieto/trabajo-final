pipeline {
  agent {
    // Easiest: run in a clean Python container each build
    docker { image 'python:3.12-slim' }
  }

  options {
    timestamps()
  }

  environment {
    VENV = '.venv'
    // Exclusiones comunes
    BANDIT_EXCLUDE = ".venv,static,media,migrations,__pycache__,.git,.tox"
  }

  stages {

    stage('Checkout') {
      steps {
        git url: 'https://github.com/adeyosemanputra/pygoat.git', branch: 'master'
      }
    }

    stage('Instalacion Bandit') {
      steps {
        sh '''
          python -V
          python -m venv "${VENV}"
          . "${VENV}/bin/activate"
          pip install --upgrade pip
          pip install bandit
        '''
      }
    }

    stage('Bandit SAST') {
      steps {
        sh '''
          . "${VENV}/bin/activate"
          mkdir -p reports

          # Human-readable
          bandit -r . -x "${BANDIT_EXCLUDE}" -f txt  -o reports/bandit_report.txt

          # Machine-readable
          bandit -r . -x "${BANDIT_EXCLUDE}" -f json -o reports/bandit_report.json

          # HTML report (nice for Jenkins publishing)
          bandit -r . -x "${BANDIT_EXCLUDE}" -f html -o reports/bandit_report.html

          # Gate: report only MEDIUM+ severity (-ll) and HIGH confidence (-iii).
          # This step will fail the build if issues are found (Bandit returns non-zero).
          bandit -r . -x "${BANDIT_EXCLUDE}" -ll -iii -f txt -o reports/bandit_gate.txt
        '''
      }
    }
  }

  post {
    always {
      archiveArtifacts artifacts: 'reports/*', fingerprint: true
    }
  }
}
