pipeline {
  agent {
    // Easiest: run in a clean Python container each build
    docker { image 'python:3.12-slim' }
  }

  options {
    timestamps()
  }

  environment {
    VENV = '.venv'
    DT_URL = 'http://localhost:8081'
    DT_API_KEY = credentials('dependency-track-api-key')    
  }

  stages {

    stage('Limpieza Workspace') {
      steps {
        cleanWs()
      }
    }

    stage('Checkout') {
      steps {
        git url: 'https://github.com/adeyosemanputra/pygoat.git', branch: 'master'
      }
    }

    stage('Instalacion Bandit') {
      steps {
        sh '''
          ls -la
          python -V
          python -m venv "../${VENV}"
          . "../${VENV}/bin/activate"
          pip install --upgrade pip
          pip install bandit
        '''
      }
    }

    stage('Bandit SAST') {
      steps {
        sh '''
          ls -la        
          . "../${VENV}/bin/activate"
          mkdir -p reports
          bandit -r . --exit-zero -f txt -o reports/bandit_report.txt
          bandit -r . --exit-zero -f html -o reports/bandit_report.html
          bandit -r . --exit-zero -f json -o reports/bandit_report.json
        '''
      }
    }

    stage('SCA - Dependency-Track') {
        steps {
            sh '''
            curl -X POST "$DT_URL/api/v1/bom" \
              -H "X-Api-Key: $DT_API_KEY" \
              -F "projectName=pygoat" \
              -F "projectVersion=1.0.0" \
              -F "autoCreate=true" \
              -F "bom=@dependency-track-bom.xml"
            '''
        }
    }

  }

  post {
    always {
      archiveArtifacts artifacts: 'reports/*', fingerprint: true
    }
  }
}
