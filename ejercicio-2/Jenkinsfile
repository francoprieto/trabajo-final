pipeline {
  // Utilizamos la imagen my-python (ver resources/docker/python/Dockerfile)
  // que tiene instalado curl, tar y git, herramientas necesarias para gitleaks
  // y hacemos que se una a la red creada en docker-compose
  agent {
    docker { 
      image 'my-python:1.1.0'
      args '--network docker_default' 
    }
  }

  options {
    timestamps()
  }

  environment {
    VENV = '.venv' 
  }

  stages {

    // Etapa para eliminar los archivos del workspace
    stage('Limpieza Workspace') {
      steps {
        cleanWs()
      }
    }

    // Etapa para clonar la rama master de pygoat
    stage('Checkout') {
      steps {
        git url: 'https://github.com/adeyosemanputra/pygoat.git', branch: 'master'
      }
    }

    // Etapa para instalar bandit
    stage('Instalacion Bandit') {
      steps {
        sh '''
          python -V
          python -m venv "../${VENV}"
          . "../${VENV}/bin/activate"
          pip install --upgrade pip
          pip install bandit
        '''
      }
    }

    // Etapa para analizar pygoat con bandit y guardar los reportes en el directorio reports
    stage('Bandit SAST') {
      steps {
        sh '''      
          . "../${VENV}/bin/activate"
          mkdir -p reports
          bandit -r . --exit-zero -f txt -o reports/bandit_report.txt
          bandit -r . --exit-zero -f html -o reports/bandit_report.html
          bandit -r . --exit-zero -f json -o reports/bandit_report.json
        '''
      }
    }

    // Etapa para instalar cyclonedx-bom y generar el archivo dependency-track-bom.xml necesario para dependency-track
    stage('Preparando dependencias') {
      steps {
        sh '''      
          . "../${VENV}/bin/activate"
          pip install cyclonedx-bom
          cyclonedx-py requirements -o reports/dependency-track-bom.xml 
        '''
      }      
    }

    // Etapa para envío de información de dependencia a dependency-track para su análisis
    stage('SCA - Dependency-Track') {
      steps {
          withCredentials([
            string(credentialsId: 'dependency-track-api-key', variable: 'DTRACK_API_KEY')
          ]) {
              dependencyTrackPublisher(
                  artifact: 'reports/dependency-track-bom.xml',
                  dependencyTrackUrl: 'http://dt-apiserver:8080',
                  dependencyTrackApiKey: DTRACK_API_KEY,
                  projectName: 'pygoat',
                  projectVersion: '1.0.0',
                  autoCreateProjects: true,
                  synchronous: false
              )
          }        
      }
    }

    // Etapa de descarga y ejecución de análisis de secretos con GitLeaks
    // El reporte también se guarda en el directorio reports
    stage('Analisis Secretos - GitLeaks') {
      steps {
        sh '''
          echo "Descargando e instalando GitLeaks...."
          curl -sSL -o /tmp/gitleaks.tar.gz "https://github.com/gitleaks/gitleaks/releases/download/v8.30.0/gitleaks_8.30.0_linux_x64.tar.gz"
          tar zxvf /tmp/gitleaks.tar.gz gitleaks
          chmod +x gitleaks

          echo "Ejecutando GitLeaks..."   
          ./gitleaks detect \
            --source . \
            --redact \
            --report-format json \
            --report-path reports/gitleaks.json \
            --exit-code 0

        '''
      }
    }

    // Etapa que integra los reportes en DefectDojo 
    stage('Integracion DefectDojo') {

      steps {
          withCredentials([
            string(credentialsId: 'defectdojo-api-key', variable: 'DD_API_KEY')
          ]) {
            sh '''
              # URL de defect dojo
              DD_URL="http://defectdojo-nginx:8080"

              PRODUCT_TYPE="PyGoat"
              PRODUCT_NAME="pygoat"
              ENGAGEMENT_NAME="CI - ${BRANCH_NAME:-master}"
              TAGS="jenkins,ci,pygoat"

              echo "Importando Bandit (SAST) a DefectDojo..."
              curl -sS -X POST "${DD_URL}/api/v2/import-scan/" \
                -H "Authorization: Token ${DD_API_KEY}" \
                -H "accept: application/json" \
                -F "scan_type=Bandit Scan" \
                -F "minimum_severity=Info" \
                -F "active=true" \
                -F "verified=false" \
                -F "auto_create_context=true" \
                -F "product_type_name=${PRODUCT_TYPE}" \
                -F "product_name=${PRODUCT_NAME}" \
                -F "engagement_name=${ENGAGEMENT_NAME}" \
                -F "tags=${TAGS}" \
                -F "file=@reports/bandit_report.json"

              echo "Importando GitLeaks (Secrets) a DefectDojo..."
              curl -sS -X POST "${DD_URL}/api/v2/import-scan/" \
                -H "Authorization: Token ${DD_API_KEY}" \
                -H "accept: application/json" \
                -F "scan_type=Gitleaks Scan" \
                -F "minimum_severity=Info" \
                -F "active=true" \
                -F "verified=false" \
                -F "auto_create_context=true" \
                -F "product_type_name=${PRODUCT_TYPE}" \
                -F "product_name=${PRODUCT_NAME}" \
                -F "engagement_name=${ENGAGEMENT_NAME}" \
                -F "tags=${TAGS}" \
                -F "file=@reports/gitleaks.json"

              echo "Importando CycloneDX BOM (SCA) a DefectDojo..."
              curl -sS -X POST "${DD_URL}/api/v2/import-scan/" \
                -H "Authorization: Token ${DD_API_KEY}" \
                -H "accept: application/xml" \
                -F "scan_type=CycloneDX Scan" \
                -F "minimum_severity=Info" \
                -F "active=true" \
                -F "verified=false" \
                -F "auto_create_context=true" \
                -F "product_type_name=${PRODUCT_TYPE}" \
                -F "product_name=${PRODUCT_NAME}" \
                -F "engagement_name=${ENGAGEMENT_NAME}" \
                -F "tags=${TAGS}" \
                -F "file=@reports/dependency-track-bom.xml"
            '''
        }
      }
    }  

  }

  // Archivamos todos los reportes que se encuentren dentro del directorio reports
  post {
    always {
      archiveArtifacts artifacts: 'reports/*', fingerprint: true
    }
  }
}